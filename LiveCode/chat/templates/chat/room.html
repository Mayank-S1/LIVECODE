<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>Chat Room</title>

        <script src= "https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.1/codemirror.min.js"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.1/codemirror.min.css">
        <script src="{{ file }}"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.1/theme/ayu-dark.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.1/addon/edit/closebrackets.min.js"></script>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.5/jquery.min.js"></script>


    <form>
        <h3>Language</h3>
        <input  type="hidden" name="room_name" value="{{ room_name }}">
         <input  type="hidden" name="User" value="{{ user }}">
           <input type="submit" value="Python" onclick="javascript: form.action='{% url 'python' %}';">
        <input type="submit" value="Cpp" onclick="javascript: form.action='{% url 'cpp' %}';">
        <input type="submit" value="Java" onclick="javascript: form.action='{% url 'java' %}';">

    </form>


</head>
<body>
    <div class="grid-container">

          <div class="grid-item">
              <h3>CODE EDITOR: {{ lg }}</h3>
              <textarea id="editor"cols="90" rows="20" placeholder="Write your Code Here"></textarea><br>
              <input type="button" onclick="myFunction1()" value="COMPILE">
              <input type="button" onclick="myFunction2()" value="RUN">

             <h4>OUTPUT</h4>
             <textarea  rows="4" cols="50" id="output" placeholder="Your output will be shown here" readonly></textarea>
          </div>

          <div class="grid-item">
              <h3>CHAT</h3>
              <textarea id="chat-log" cols="60" rows="20" readonly></textarea><br>
              <input id="chat-message-input" type="text" size="50"><br>
              <input id="chat-message-submit" type="button" value="Send">
          </div>
    </div>
    <p id="check" ></p>

    <script>

        var editor = CodeMirror.fromTextArea(document.getElementById('editor'),{
             mode: "{{ mode }}",
             lineNumbers: true,
              theme: "ayu-dark",
              autoCloseBrackets: true,
              smartIndent : true,
             });

        const roomName = '{{ room_name }}'
        const user = '{{ user }}'
        var flag1,flag2;
        var enter1 = ["\n"];
        var enter2 = ["\n\n"];

        if(user=='Interviewer')
        {
        flag1 = 0;
        flag2 = 1;
        }
        else if(user == 'Student')
        {
         flag1 = 1;
         flag2 = 0;
        }

        function editorControl(){
         var s = flag1;
         var r = flag2;

         chatSocket.send(JSON.stringify({
                    'message': {
                        's': s,
                        'r': r,
                        'type':'editorControl',
                    }
                }));


        }



        const chatSocket = new WebSocket(
            'ws://'
            + window.location.host
            + '/ws/chat/room'
            + '/'
        );

        editor.on("keyup", function(editor, e) {
          key = e.keyCode;
          if(e.keyCode === 17)//on;y Interviewer can stop student and continue by ctrl key
          {
           editorControl();
          }

        });


        editor.on('change', function(e, changeObj){
        //console.log(changeObj.text.length);
        console.log(changeObj);
           if(flag1 == 1)
           {

         if(changeObj.text.length === 2)
          changeObj.text = enter1;
          if(changeObj.text.length === 3)
          changeObj.text = enter2;

           chatSocket.send(JSON.stringify({
                    'message': {
                        changes: changeObj,
                        type: 'CODE',
                    }
                }));
            }

         });



        chatSocket.onmessage = function(e) {
            var data = JSON.parse(e.data);
            var type = data.message.type;
           if(type == 'editorControl' )
           {
                if(user == 'Student')
                {
                flag1 = data.message.s;
                flag2 = data.message.r;
                if(flag1 == '0')
                alert('Stop Code');
                else
                alert('Continue Code');
                }
                else if(user == 'Interviewer')
                {
                flag1=data.message.s ^ 1;
                flag2=data.message.r ^ 1;
                }
                console.log(flag1);
                console.log(flag2);

           }
           else if(type == 'CODE' &&  flag2 == 1)
           {
                    var fromPos = {
                        line: data.message.changes.from.line,
                        ch: data.message.changes.from.ch,

                    };
                    var toPos = {
                        line: data.message.changes.to.line,
                        ch: data.message.changes.to.ch,
                    };
                    var code = data.message.changes.text[0];

                    editor.doc.replaceRange(code, fromPos, toPos);


             }
             else if(type == 'CHAT')
             {
              document.querySelector('#chat-log').value += ( data.message.message + '\n');
             }
             else if(type == 'OP')
             {
               document.querySelector('#output').value = '';
               document.querySelector('#output').value =  data.message.message ;
             }
        };


        chatSocket.onclose = function(e) {
            console.error('Chat socket closed unexpectedly');
        };


        document.querySelector('#chat-message-input').onkeyup = function(e) {
            if (e.keyCode === 13) {  // enter, return
                document.querySelector('#chat-message-submit').click();
            }
        };



        document.querySelector('#chat-message-submit').onclick = function(e) {
            const messageInputDom = document.querySelector('#chat-message-input');
            var message = messageInputDom.value;
            message = user + ':' + message;
             chatSocket.send(JSON.stringify({
                'message': {
                        message: message,
                        type: 'CHAT',
                }
            }));
            messageInputDom.value = '';
        };

    </script>
 <script>
         function myFunction1(){

         var text = editor.getValue();
         var formData = {source:text,lang:"{{ lg }}"};
         $.ajax({
                  url : "{% url 'compile' %}",
                  type: "POST",
                  data : formData,
                  success: function(data, textStatus, jqXHR){
                        res = JSON.stringify(data['compile_status']);
                        chatSocket.send(JSON.stringify({
                        'message': {
                             message: res,
                              type: 'OP',
                            }
                       }));
                   },
                   error: function (jqXHR, textStatus, errorThrown){
                   alert(errorThrown);
                   }
               });

            }

          function myFunction2(){
            var text =  editor.getValue();
            var formData = {source:text,lang:"{{ lg }}"};
            $.ajax({
                    url : "{% url 'run' %}",
                    type: "POST",
                    data : formData,
                   success: function(data, textStatus, jqXHR)   {
                        res = JSON.stringify(data['run_status']['output']);
                        chatSocket.send(JSON.stringify({
                        'message': {
                             message: res,
                              type: 'OP',
                             }

                       }));
                     },
                   error: function (jqXHR, textStatus, errorThrown){
                   alert(errorThrown);
                   }
                });

               }


      </script>


</body>
</html>